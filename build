#!/bin/bash
set -e

MIX_ENV=prod mix release prod --overwrite --force

export PHX_SERVER="true"
#export RELEASE_NAME="cool_release"
export SECRET_KEY_BASE="$(mix phx.gen.secret)"
export DATABASE_URL="postgres://postgres:postgres@localhost:5432/dave_dev"
export HTTP_PORT=4000
export HTTPS_PORT=4443
export SSL_CERT_PATH="priv/cert/selfsigned.pem"
export SSL_KEY_PATH="priv/cert/selfsigned_key.pem"
echo $APP_HOST
export PHX_HOST="$APP_HOST:$HTTPS_PORT"
#export PHX_HOST=$APP_HOST
echo $PHX_HOST

if [[ "$1" == "-r" ]]; then
  _build/prod/rel/prod/bin/prod start 2> log_file 1> log_file &
  echo "Running with pid $!"
fi

if [[ "$1" == "-d" ]]; then
  tar -czvf release.tar _build/prod/rel/prod
  scp release.tar berners@dave:~/
  scp deploy berners@dave:~/
fi

